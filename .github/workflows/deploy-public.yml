name: Deploy Public Version to Separate Repository

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy-public:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install
        
      - name: Build public version
        run: |
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—É—é —Å–±–æ—Ä–∫—É
          npm run build-public
          
          # –û–±–Ω–æ–≤–ª—è–µ–º BASE_URL –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          sed -i "s|https://your-username.github.io/mini-flowy|https://${{ github.repository_owner }}.github.io/mini-flowy-public|g" public-build/generate-seo-pages.js
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SEO —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏
          cd public-build
          node generate-seo-pages.js
          
      - name: Deploy to public repository
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
          git clone https://${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/${{ github.repository_owner }}/mini-flowy-public.git public-repo
          
          # –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
          cd public-repo
          rm -rf * .github .gitignore || true
          
          # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–±–æ—Ä–∫—É
          cp -r ../public-build/* .
          cp -r ../public-build/.github . || true
          
          # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add .
          git commit -m "ü§ñ Auto-deploy public version from private repo
          
          üìä Statistics:
          - Generated on: $(date)
          - Source commit: ${{ github.sha }}
          - Public pages: $(cat pages.json | grep '\"public\": true' | wc -l)
          
          üîó Source: https://github.com/${{ github.repository }}"
          
          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push origin main
          
  notify:
    runs-on: ubuntu-latest
    needs: deploy-public
    if: always()
    
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy-public.result }}" == "success" ]; then
            echo "‚úÖ Public version deployed successfully!"
            echo "üîó Available at: https://${{ github.repository_owner }}.github.io/mini-flowy-public"
          else
            echo "‚ùå Public deployment failed!"
          fi
